<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promotions Manager</title>
    
    <!-- React & ReactDOM (Development) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel Standalone (para compilar JSX en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide React (CDN) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { background-color: #f8fafc; margin: 0; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- ICONOS ---
        const toCamelCase = (str) => str.replace(/-([a-z])/g, (g) => g[1].toUpperCase());

        const IconWrapper = ({ name, className, size = 24, color = "currentColor", strokeWidth = 2, ...props }) => {
            const iconData = lucide.icons[name];
            
            if (!iconData) {
                console.warn(`Icon not found: ${name}`);
                return null;
            }

            const convertAttrs = (attrs) => {
                const reactAttrs = {};
                for (const [key, value] of Object.entries(attrs)) {
                    reactAttrs[toCamelCase(key)] = value;
                }
                return reactAttrs;
            };

            return (
                <svg 
                    xmlns="http://www.w3.org/2000/svg" 
                    width={size} 
                    height={size} 
                    viewBox="0 0 24 24" 
                    fill="none" 
                    stroke={color} 
                    strokeWidth={strokeWidth} 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                    className={className}
                    {...props}
                >
                    {iconData.map((child, index) => {
                        const [tag, attrs] = child;
                        return React.createElement(tag, { 
                            ...convertAttrs(attrs), 
                            key: index 
                        });
                    })}
                </svg>
            );
        };

        // Definici√≥n de Iconos usados en el c√≥digo
        const Plus = (props) => <IconWrapper name="Plus" {...props} />;
        const Search = (props) => <IconWrapper name="Search" {...props} />;
        const Filter = (props) => <IconWrapper name="Filter" {...props} />;
        const MoreHorizontal = (props) => <IconWrapper name="MoreHorizontal" {...props} />;
        const Ticket = (props) => <IconWrapper name="Ticket" {...props} />;
        const Users = (props) => <IconWrapper name="Users" {...props} />;
        const Percent = (props) => <IconWrapper name="Percent" {...props} />;
        const X = (props) => <IconWrapper name="X" {...props} />;
        const ChevronRight = (props) => <IconWrapper name="ChevronRight" {...props} />;
        const ChevronDown = (props) => <IconWrapper name="ChevronDown" {...props} />;
        const ChevronUp = (props) => <IconWrapper name="ChevronUp" {...props} />;
        const Check = (props) => <IconWrapper name="Check" {...props} />;
        const AlertCircle = (props) => <IconWrapper name="AlertCircle" {...props} />;
        const Calendar = (props) => <IconWrapper name="Calendar" {...props} />;
        const Euro = (props) => <IconWrapper name="Euro" {...props} />;
        const Copy = (props) => <IconWrapper name="Copy" {...props} />;
        const Layers = (props) => <IconWrapper name="Layers" {...props} />;
        const Globe = (props) => <IconWrapper name="Globe" {...props} />;
        const MapPin = (props) => <IconWrapper name="MapPin" {...props} />;
        const ShoppingBag = (props) => <IconWrapper name="ShoppingBag" {...props} />;
        const Briefcase = (props) => <IconWrapper name="Briefcase" {...props} />;
        const Zap = (props) => <IconWrapper name="Zap" {...props} />;
        const Play = (props) => <IconWrapper name="Play" {...props} />;
        const Pause = (props) => <IconWrapper name="Pause" {...props} />;
        const Edit = (props) => <IconWrapper name="Edit" {...props} />;
        const Trash2 = (props) => <IconWrapper name="Trash2" {...props} />;
        const UserPlus = (props) => <IconWrapper name="UserPlus" {...props} />;
        const UserCheck = (props) => <IconWrapper name="UserCheck" {...props} />;
        const UserX = (props) => <IconWrapper name="UserX" {...props} />;
        const ListFilter = (props) => <IconWrapper name="ListFilter" {...props} />;


        // --- C√ìDIGO DEL USUARIO ---
        
        function PromotionsModule() {
          const [isWizardOpen, setIsWizardOpen] = useState(false);
          const [activeTab, setActiveTab] = useState('active');
          const [expandedRow, setExpandedRow] = useState(null); // ID de la fila desplegada

          // --- FILTERS STATE ---
          const [searchQuery, setSearchQuery] = useState('');
          const [showFilters, setShowFilters] = useState(false);
          const [filters, setFilters] = useState({
            type: 'all',        // all, batch, single, general
            discountType: 'all' // all, percent, fixed
          });

          // --- MOCK DATA ---
          const [campaigns, setCampaigns] = useState([
            {
              id: 1,
              name: "Campa√±a RRPP Verano",
              trigger: "code",
              type: "batch",
              codeDisplay: "RRPP-...",
              discount: "20%",
              scope: "Entrada + Compl.",
              usage: 45,
              limit: 100,
              status: "active",
              revenueImpact: 1250,
              teams: ["RRPP Noche", "Embajadores"],
              breakdown: [
                { id: 101, team: "RRPP Noche", promoter: "Juan P√©rez", code: "RRPP-JUAN", uses: 12, status: 'active' },
                { id: 102, team: "RRPP Noche", promoter: "Ana Gomez", code: "RRPP-ANA", uses: 8, status: 'paused' },
                { id: 103, team: "Embajadores", promoter: "Luis Uni", code: "RRPP-LUIS", uses: 25, status: 'active' },
              ]
            },
            {
              id: 2,
              name: "Influencer: MariaG",
              trigger: "code",
              type: "single",
              codeDisplay: "MARIAG-VIP",
              discount: "10‚Ç¨",
              scope: "Solo Cover",
              usage: 12,
              limit: null,
              status: "paused",
              revenueImpact: 120
            },
            {
              id: 3,
              name: "Early Bird Autom√°tico",
              trigger: "automatic",
              type: "general",
              codeDisplay: "AUTO-APLICADO",
              discount: "5%",
              scope: "Entrada General",
              usage: 150,
              limit: 200,
              status: "active",
              revenueImpact: 850
            },
            {
              id: 4,
              name: "Flash Sale Viernes",
              trigger: "code",
              type: "single",
              codeDisplay: "VIERNES50",
              discount: "50%",
              scope: "Entrada General",
              usage: 10,
              limit: 50,
              status: "active",
              revenueImpact: 200
            }
          ]);

          // --- WIZARD STATE ---
          const [step, setStep] = useState(1);
          const [formData, setFormData] = useState({
            name: '',
            triggerType: 'code', // code | automatic (NUEVO)
            mode: 'single', // single | batch
            codeSingle: '',
            
            // Batch specific fields (NUEVOS)
            selectedTeams: [], 
            batchExceptions: '', 
            batchPrefix: '',
            batchQty: 50,
            
            valueType: 'percent', 
            valueAmount: '',
            
            productScope: 'total_bundle',
            componentScope: {
                totalPrice: true,
                perPerson: false,
                coverCharge: false,
                minSpend: false,
                prepay: false
            },
            
            globalLimit: '',
            buyerLimit: 1,
            startDate: '',
            endDate: '',
            
            selectedWebs: [],
            selectedVenues: [],
            selectedEvents: [],
            selectedProducts: []
          });

          // --- HANDLERS ---

          const toggleTeam = (team) => {
            setFormData(prev => {
                const teams = prev.selectedTeams.includes(team)
                    ? prev.selectedTeams.filter(t => t !== team)
                    : [...prev.selectedTeams, team];
                return { ...prev, selectedTeams: teams };
            });
          };

          const toggleComponent = (key) => {
            setFormData(prev => ({
                ...prev,
                componentScope: {
                    ...prev.componentScope,
                    [key]: !prev.componentScope[key]
                }
            }));
          };

          const handleStatusToggle = (id) => {
            setCampaigns(prev => prev.map(c => {
                if (c.id === id) {
                    return { ...c, status: c.status === 'active' ? 'paused' : 'active' };
                }
                return c;
            }));
          };
          
          const handlePromoterStatusToggle = (campaignId, promoterId) => {
            setCampaigns(prev => prev.map(c => {
                if (c.id === campaignId) {
                    const updatedBreakdown = c.breakdown.map(p => {
                        if (p.id === promoterId) {
                            return { ...p, status: p.status === 'active' ? 'paused' : 'active' };
                        }
                        return p;
                    });
                    return { ...c, breakdown: updatedBreakdown };
                }
                return c;
            }));
          };

          const handleAddPromoter = (campaignId) => {
              setCampaigns(prev => prev.map(c => {
                if (c.id === campaignId) {
                    const newPromoter = {
                        id: Date.now(),
                        team: "Nuevo Asignado",
                        promoter: "Promotor Nuevo",
                        code: `NUEVO-${Math.floor(Math.random() * 1000)}`,
                        uses: 0,
                        status: 'active'
                    };
                    return { ...c, breakdown: [newPromoter, ...(c.breakdown || [])] };
                }
                return c;
            }));
          };

          const handleEdit = (campaign) => {
            setIsWizardOpen(true);
          };

          const handleCreate = () => {
            const newCampaign = {
              id: campaigns.length + 1,
              name: formData.name || "Nueva Campa√±a",
              trigger: formData.triggerType,
              type: formData.triggerType === 'automatic' ? 'general' : formData.mode,
              codeDisplay: formData.triggerType === 'automatic' ? 'AUTO' : (formData.mode === 'single' ? formData.codeSingle : `${formData.batchPrefix}-...`),
              discount: formData.valueType === 'percent' ? `${formData.valueAmount}%` : `${formData.valueAmount}‚Ç¨`,
              scope: formData.productScope === 'ticket_only' ? 'Solo Entrada' : 'Entrada + Compl.',
              usage: 0,
              limit: formData.globalLimit || '‚àû',
              status: 'active',
              revenueImpact: 0,
              breakdown: [] 
            };
            setCampaigns([newCampaign, ...campaigns]);
            setIsWizardOpen(false);
            setStep(1);
          };

          // --- FILTER LOGIC ---
          const filteredCampaigns = campaigns.filter(campaign => {
            // 1. Status Tab Filter
            if (activeTab === 'active' && campaign.status !== 'active') return false;
            if (activeTab === 'paused' && campaign.status !== 'paused') return false;

            // 2. Search Query Filter
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                const matchesName = campaign.name.toLowerCase().includes(q);
                const matchesCode = campaign.codeDisplay.toLowerCase().includes(q);
                if (!matchesName && !matchesCode) return false;
            }

            // 3. Type Filter
            if (filters.type !== 'all' && campaign.type !== filters.type) return false;

            // 4. Discount Type Filter (Percentage vs Fixed)
            if (filters.discountType !== 'all') {
                const isPercent = campaign.discount.includes('%');
                if (filters.discountType === 'percent' && !isPercent) return false;
                if (filters.discountType === 'fixed' && isPercent) return false;
            }

            return true;
          });

          // Calculate counts for badges
          const activeCount = campaigns.filter(c => c.status === 'active').length;

          return (
            <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
              
              {/* --- HEADER --- */}
              <header className="bg-white border-b border-slate-200 px-8 py-5 flex justify-between items-center sticky top-0 z-10">
                <div>
                  <h1 className="text-2xl font-bold text-slate-900">Promociones y Descuentos</h1>
                  <p className="text-sm text-slate-500">Gestiona campa√±as autom√°ticas, c√≥digos de RRPP y descuentos.</p>
                </div>
                <button 
                  onClick={() => setIsWizardOpen(true)}
                  className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2.5 rounded-lg flex items-center gap-2 font-medium transition-all shadow-sm active:transform active:scale-95"
                >
                  <Plus className="w-5 h-5" />
                  Crear Campa√±a
                </button>
              </header>

              <main className="max-w-7xl mx-auto p-8">
                
                {/* --- KPI CARDS --- */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                  <KpiCard title="Campa√±as Activas" value={activeCount} icon={Ticket} color="text-indigo-600" bg="bg-indigo-50" />
                  <KpiCard title="C√≥digos Canjeados" value="207" icon={Users} color="text-emerald-600" bg="bg-emerald-50" sub="Esta semana" />
                  <KpiCard title="Total Descontado" value="2,220‚Ç¨" icon={Euro} color="text-amber-600" bg="bg-amber-50" sub="Impacto Global" />
                  <KpiCard title="Retorno (ROI)" value="12.5x" icon={Percent} color="text-blue-600" bg="bg-blue-50" sub="Ingresos generados" />
                </div>

                {/* --- TABLE CONTROLS & FILTERS --- */}
                <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="p-5 border-b border-slate-100">
                        <div className="flex justify-between items-center mb-4">
                            {/* TABS */}
                            <div className="flex gap-1 bg-slate-100 p-1 rounded-lg">
                            {['active', 'paused', 'all'].map((tab) => (
                                <button
                                key={tab}
                                onClick={() => setActiveTab(tab)}
                                className={`px-4 py-1.5 text-sm font-medium rounded-md transition-all ${
                                    activeTab === tab 
                                    ? 'bg-white text-slate-900 shadow-sm' 
                                    : 'text-slate-500 hover:text-slate-700'
                                }`}
                                >
                                {tab === 'active' ? 'Activas' : tab === 'paused' ? 'Pausadas' : 'Todas'}
                                </button>
                            ))}
                            </div>

                            {/* SEARCH & FILTER TOGGLE */}
                            <div className="flex gap-2">
                                <div className="relative">
                                    <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input 
                                        type="text" 
                                        placeholder="Buscar campa√±a o c√≥digo..." 
                                        className="pl-9 pr-4 py-2 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-64"
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                </div>
                                <button 
                                    onClick={() => setShowFilters(!showFilters)}
                                    className={`flex items-center gap-2 px-3 py-2 border rounded-lg text-sm font-medium transition-colors ${
                                        showFilters ? 'bg-indigo-50 border-indigo-200 text-indigo-700' : 'border-slate-200 hover:bg-slate-50 text-slate-600'
                                    }`}
                                >
                                    <ListFilter className="w-4 h-4" />
                                    Filtros
                                    {(filters.type !== 'all' || filters.discountType !== 'all') && (
                                        <span className="bg-indigo-600 text-white text-[10px] px-1.5 rounded-full">!</span>
                                    )}
                                </button>
                            </div>
                        </div>

                        {/* EXPANDABLE FILTER PANEL */}
                        {showFilters && (
                            <div className="p-4 bg-slate-50 rounded-lg border border-slate-200 animate-in slide-in-from-top-2 fade-in">
                                <div className="flex items-end gap-6">
                                    
                                    {/* Filter by Campaign Type */}
                                    <div className="w-48">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1.5 block">Tipo de Campa√±a</label>
                                        <select 
                                            className="w-full text-sm border border-slate-300 rounded-md px-2 py-1.5 bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                            value={filters.type}
                                            onChange={(e) => setFilters({...filters, type: e.target.value})}
                                        >
                                            <option value="all">Todos los tipos</option>
                                            <option value="batch">Batch / RRPP (M√∫ltiple)</option>
                                            <option value="single">C√≥digo √önico</option>
                                            <option value="general">Autom√°tica</option>
                                        </select>
                                    </div>

                                    {/* Filter by Discount Type */}
                                    <div className="w-48">
                                        <label className="text-xs font-bold text-slate-500 uppercase mb-1.5 block">Tipo de Descuento</label>
                                        <select 
                                            className="w-full text-sm border border-slate-300 rounded-md px-2 py-1.5 bg-white focus:ring-2 focus:ring-indigo-500 outline-none"
                                            value={filters.discountType}
                                            onChange={(e) => setFilters({...filters, discountType: e.target.value})}
                                        >
                                            <option value="all">Cualquier valor</option>
                                            <option value="percent">Porcentaje (%)</option>
                                            <option value="fixed">Importe Fijo (‚Ç¨)</option>
                                        </select>
                                    </div>

                                    {/* Clear Filters */}
                                    {(filters.type !== 'all' || filters.discountType !== 'all') && (
                                        <button 
                                            onClick={() => setFilters({ type: 'all', discountType: 'all' })}
                                            className="text-xs text-slate-500 hover:text-red-600 underline pb-2"
                                        >
                                            Limpiar filtros
                                        </button>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                  {/* --- CAMPAIGNS TABLE --- */}
                  <table className="w-full text-left border-collapse">
                    <thead className="bg-slate-50 text-xs uppercase font-semibold text-slate-500">
                      <tr>
                        <th className="px-6 py-4">Nombre Campa√±a</th>
                        <th className="px-6 py-4">Tipo & Trigger</th>
                        <th className="px-6 py-4">Beneficio</th>
                        <th className="px-6 py-4">Alcance</th>
                        <th className="px-6 py-4">Uso / L√≠mite</th>
                        <th className="px-6 py-4 text-center">Estado</th>
                        <th className="px-6 py-4 text-right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {filteredCampaigns.length > 0 ? (
                        filteredCampaigns.map((camp) => (
                            <React.Fragment key={camp.id}>
                            <tr className={`hover:bg-slate-50 transition-colors group ${expandedRow === camp.id ? 'bg-indigo-50/30' : ''}`}>
                            <td className="px-6 py-4">
                                <div className="flex items-center gap-3">
                                    {/* Icono de Tipo */}
                                    <div className={`p-2 rounded-full ${
                                        camp.trigger === 'automatic' ? 'bg-amber-100 text-amber-600' : 
                                        camp.type === 'batch' ? 'bg-purple-100 text-purple-600' : 'bg-blue-100 text-blue-600'
                                    }`}>
                                        {camp.trigger === 'automatic' ? <Zap className="w-4 h-4" /> : 
                                        camp.type === 'batch' ? <Users className="w-4 h-4" /> : <Ticket className="w-4 h-4" />}
                                    </div>
                                    <div>
                                        <p className="font-semibold text-slate-800">{camp.name}</p>
                                        {camp.type === 'batch' && (
                                            <button 
                                                onClick={() => setExpandedRow(expandedRow === camp.id ? null : camp.id)}
                                                className="text-[10px] text-indigo-600 hover:text-indigo-800 flex items-center gap-1 mt-0.5 font-medium"
                                            >
                                                {expandedRow === camp.id ? 'Ocultar desglose' : 'Ver equipos'} 
                                                {expandedRow === camp.id ? <ChevronUp className="w-3 h-3" /> : <ChevronDown className="w-3 h-3" />}
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </td>
                            <td className="px-6 py-4">
                                <div className="flex flex-col gap-1">
                                    <span className="text-xs font-medium text-slate-600 flex items-center gap-1.5">
                                        {camp.trigger === 'automatic' ? '‚ö° Autom√°tica' : 'üîë C√≥digo'}
                                    </span>
                                    <span className="font-mono text-xs text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded w-fit">
                                        {camp.codeDisplay}
                                    </span>
                                </div>
                            </td>
                            <td className="px-6 py-4">
                                <span className="font-bold text-slate-700">{camp.discount}</span>
                            </td>
                            <td className="px-6 py-4 text-sm text-slate-600">
                                {camp.scope}
                            </td>
                            <td className="px-6 py-4">
                                <div className="flex items-center gap-2 text-sm text-slate-700">
                                <div className="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
                                    <div 
                                    className={`h-full rounded-full ${camp.status === 'active' ? 'bg-emerald-500' : 'bg-slate-300'}`} 
                                    style={{ width: `${camp.limit ? (camp.usage / camp.limit) * 100 : 50}%` }}
                                    ></div>
                                </div>
                                <span className="text-xs font-medium">{camp.usage} / {camp.limit || '‚àû'}</span>
                                </div>
                            </td>
                            <td className="px-6 py-4 text-center">
                                <span className={`inline-flex px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${
                                    camp.status === 'active' ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 text-slate-500'
                                }`}>
                                    {camp.status === 'active' ? 'Activa' : 'Pausada'}
                                </span>
                            </td>
                            <td className="px-6 py-4 text-right">
                                <div className="flex items-center justify-end gap-2">
                                    <button 
                                        onClick={() => handleStatusToggle(camp.id)}
                                        className="p-1.5 rounded hover:bg-slate-200 text-slate-500 hover:text-slate-700"
                                        title={camp.status === 'active' ? "Pausar" : "Reanudar"}
                                    >
                                        {camp.status === 'active' ? <Pause className="w-4 h-4" /> : <Play className="w-4 h-4" />}
                                    </button>
                                    <button 
                                        onClick={() => handleEdit(camp)}
                                        className="p-1.5 rounded hover:bg-slate-200 text-slate-500 hover:text-indigo-600"
                                        title="Editar"
                                    >
                                        <Edit className="w-4 h-4" />
                                    </button>
                                </div>
                            </td>
                            </tr>
                            {/* --- BATCH EXPANDED ROW --- */}
                            {expandedRow === camp.id && camp.type === 'batch' && (
                                <tr className="bg-slate-50/50">
                                    <td colSpan="7" className="px-6 py-4 border-t border-slate-100 shadow-inner">
                                        <div className="pl-12">
                                            <div className="flex justify-between items-center mb-3">
                                                <h4 className="text-xs font-bold text-slate-500 uppercase flex items-center gap-2">
                                                    <Users className="w-3 h-3" /> Desglose por Promotor / Equipo
                                                </h4>
                                                <button 
                                                    onClick={() => handleAddPromoter(camp.id)}
                                                    className="text-xs flex items-center gap-1 text-indigo-600 font-bold bg-white border border-indigo-200 px-3 py-1.5 rounded-lg hover:bg-indigo-50 transition-colors shadow-sm"
                                                >
                                                    <UserPlus className="w-3.5 h-3.5" />
                                                    A√±adir Promotor
                                                </button>
                                            </div>
                                            
                                            <table className="w-full max-w-3xl text-sm border border-slate-200 rounded-lg overflow-hidden bg-white">
                                                <thead className="bg-slate-100 text-slate-600 font-semibold text-xs">
                                                    <tr>
                                                        <th className="px-4 py-2 text-left">Equipo</th>
                                                        <th className="px-4 py-2 text-left">Promotor / Usuario</th>
                                                        <th className="px-4 py-2 text-left">C√≥digo Asignado</th>
                                                        <th className="px-4 py-2 text-center">Estado</th>
                                                        <th className="px-4 py-2 text-right">Usos</th>
                                                        <th className="px-4 py-2 text-right w-20">Acciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-slate-100">
                                                    {camp.breakdown && camp.breakdown.length > 0 ? (
                                                        camp.breakdown.map((row, idx) => (
                                                            <tr key={idx} className={`transition-colors ${row.status === 'paused' ? 'bg-slate-50 text-slate-400' : 'hover:bg-slate-50'}`}>
                                                                <td className="px-4 py-2">{row.team}</td>
                                                                <td className="px-4 py-2 font-medium flex items-center gap-2">
                                                                    {row.promoter}
                                                                    {row.status === 'paused' && <span className="text-[10px] uppercase bg-slate-200 text-slate-500 px-1 rounded">Pausado</span>}
                                                                </td>
                                                                <td className="px-4 py-2 font-mono text-xs text-slate-500">{row.code}</td>
                                                                <td className="px-4 py-2 text-center">
                                                                    <div className={`w-2 h-2 rounded-full mx-auto ${row.status === 'active' ? 'bg-emerald-500' : 'bg-slate-300'}`}></div>
                                                                </td>
                                                                <td className="px-4 py-2 text-right">{row.uses}</td>
                                                                <td className="px-4 py-2 text-right">
                                                                    <button 
                                                                        onClick={() => handlePromoterStatusToggle(camp.id, row.id)}
                                                                        className={`p-1 rounded transition-colors ${
                                                                            row.status === 'active' 
                                                                            ? 'text-slate-400 hover:text-amber-600 hover:bg-amber-50' 
                                                                            : 'text-emerald-600 hover:bg-emerald-50'
                                                                        }`}
                                                                        title={row.status === 'active' ? "Pausar Promotor" : "Reactivar Promotor"}
                                                                    >
                                                                        {row.status === 'active' ? <UserX className="w-4 h-4" /> : <UserCheck className="w-4 h-4" />}
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))
                                                    ) : (
                                                        <tr>
                                                            <td colSpan="6" className="px-4 py-3 text-center text-slate-400 italic">No hay datos de uso disponibles a√∫n.</td>
                                                        </tr>
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </td>
                                </tr>
                            )}
                            </React.Fragment>
                        ))
                      ) : (
                        <tr>
                            <td colSpan="7" className="px-6 py-12 text-center text-slate-400">
                                <div className="flex flex-col items-center gap-2">
                                    <Search className="w-8 h-8 opacity-20" />
                                    <p>No se encontraron campa√±as con los filtros actuales.</p>
                                    <button 
                                        onClick={() => { setSearchQuery(''); setFilters({type: 'all', discountType: 'all'}); }}
                                        className="text-indigo-600 text-sm font-medium hover:underline mt-2"
                                    >
                                        Limpiar b√∫squeda
                                    </button>
                                </div>
                            </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </main>

              {/* --- WIZARD MODAL --- */}
              {isWizardOpen && (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                  <div className="bg-white rounded-2xl shadow-2xl w-full max-w-3xl overflow-hidden flex flex-col max-h-[90vh]">
                    
                    {/* Modal Header */}
                    <div className="bg-slate-50 px-8 py-6 border-b border-slate-100 flex justify-between items-start">
                      <div>
                        <h2 className="text-xl font-bold text-slate-900">
                            {formData.name ? 'Editar Campa√±a' : 'Nueva Campa√±a'}
                        </h2>
                        <p className="text-sm text-slate-500 mt-1">Configura las reglas de tu promoci√≥n en 3 pasos.</p>
                      </div>
                      <button onClick={() => setIsWizardOpen(false)} className="text-slate-400 hover:text-slate-600">
                        <X className="w-6 h-6" />
                      </button>
                    </div>

                    {/* Stepper */}
                    <div className="px-8 pt-6 pb-2">
                      <div className="flex items-center justify-between relative">
                        <div className="absolute left-0 top-1/2 w-full h-0.5 bg-slate-100 -z-10"></div>
                        <StepIndicator num={1} title="Identidad" current={step} />
                        <StepIndicator num={2} title="Reglas" current={step} />
                        <StepIndicator num={3} title="Asignaci√≥n" current={step} />
                      </div>
                    </div>

                    {/* Modal Content (Scrollable) */}
                    <div className="p-8 overflow-y-auto flex-1">
                      
                      {/* STEP 1: IDENTITY */}
                      {step === 1 && (
                        <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
                          <InputGroup label="Nombre Interno de la Campa√±a" placeholder="Ej: Influencers Verano 2024" value={formData.name} onChange={(e) => setFormData({...formData, name: e.target.value})} />
                          
                          {/* TRIGGER TYPE SELECTOR */}
                          <div className="bg-slate-50 p-4 rounded-lg border border-slate-200">
                            <label className="text-sm font-bold text-slate-700 mb-3 block">¬øC√≥mo se activa?</label>
                            <div className="grid grid-cols-2 gap-4">
                                 <SelectableCard 
                                    selected={formData.triggerType === 'code'} 
                                    onClick={() => setFormData({...formData, triggerType: 'code', mode: 'single'})}
                                    icon={Ticket}
                                    title="Requiere C√≥digo"
                                    desc="El usuario debe introducir un cup√≥n."
                                  />
                                  <SelectableCard 
                                    selected={formData.triggerType === 'automatic'} 
                                    onClick={() => setFormData({...formData, triggerType: 'automatic', mode: 'general'})}
                                    icon={Zap}
                                    title="Autom√°tica"
                                    desc="Se aplica sola si cumple condiciones (ej. Early Bird)."
                                  />
                            </div>
                          </div>

                          {formData.triggerType === 'code' && (
                              <div className="space-y-4 animate-in fade-in slide-in-from-top-2">
                                <label className="text-sm font-bold text-slate-700">Configuraci√≥n de C√≥digos</label>
                                <div className="flex gap-2 mb-4">
                                     <button
                                        onClick={() => setFormData({...formData, mode: 'single'})}
                                        className={`px-4 py-2 rounded-md text-sm font-medium border transition-all ${
                                            formData.mode === 'single' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200'
                                        }`}
                                     >
                                        C√≥digo √önico
                                     </button>
                                     <button
                                        onClick={() => setFormData({...formData, mode: 'batch'})}
                                        className={`px-4 py-2 rounded-md text-sm font-medium border transition-all ${
                                            formData.mode === 'batch' ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200'
                                        }`}
                                     >
                                        Batch (M√∫ltiple)
                                     </button>
                                </div>

                                {formData.mode === 'single' ? (
                                    <InputGroup label="C√≥digo Promocional" placeholder="Ej: VERANO2024" value={formData.codeSingle} onChange={(e) => setFormData({...formData, codeSingle: e.target.value.toUpperCase()})} />
                                ) : (
                                    <div className="space-y-4 border-t border-slate-200 pt-4">
                                        {/* MULTI-SELECT DE EQUIPOS */}
                                        <div>
                                            <label className="text-sm font-bold text-slate-700 mb-2 block">Equipos de Promoci√≥n (Selecci√≥n M√∫ltiple)</label>
                                            <div className="grid grid-cols-2 gap-2 max-h-32 overflow-y-auto p-2 border border-slate-200 rounded-lg">
                                                {['RRPP Noche', 'RRPP Tardeo', 'Embajadores', 'Agencia Externa'].map(team => (
                                                    <label key={team} className="flex items-center gap-2 text-sm p-1.5 hover:bg-slate-50 rounded cursor-pointer">
                                                        <input 
                                                            type="checkbox" 
                                                            checked={formData.selectedTeams.includes(team)}
                                                            onChange={() => toggleTeam(team)}
                                                            className="rounded text-indigo-600 focus:ring-indigo-500"
                                                        />
                                                        {team}
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                        
                                        {/* EXCEPCIONES */}
                                        <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                                            <label className="text-xs font-bold text-purple-900 mb-1 block flex items-center gap-1">
                                                <UserPlus className="w-3 h-3" /> Excepciones / Personas Adicionales
                                            </label>
                                            <input 
                                                type="text" 
                                                className="w-full text-sm bg-white border border-purple-200 rounded px-2 py-1.5 focus:outline-none focus:border-purple-400"
                                                placeholder="Ej: juan@rrpp.com, Maria Gomez..." 
                                                value={formData.batchExceptions}
                                                onChange={(e) => setFormData({...formData, batchExceptions: e.target.value})}
                                            />
                                            <p className="text-[10px] text-purple-600 mt-1">A√±ade usuarios espec√≠ficos fuera de los equipos seleccionados.</p>
                                        </div>

                                        <div className="grid grid-cols-2 gap-4">
                                            <InputGroup label="Prefijo C√≥digo" placeholder="Ej: RRPP-" value={formData.batchPrefix} onChange={(e) => setFormData({...formData, batchPrefix: e.target.value})} />
                                            <InputGroup label="Cantidad (por miembro)" type="number" placeholder="50" value={formData.batchQty} onChange={(e) => setFormData({...formData, batchQty: e.target.value})} />
                                        </div>
                                    </div>
                                )}
                              </div>
                          )}
                        </div>
                      )}

                      {/* STEP 2: RULES */}
                      {step === 2 && (
                        <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
                          {/* Descuento Valor */}
                          <div className="flex gap-6">
                            <div className="w-1/3">
                                <label className="text-sm font-bold text-slate-700 mb-2 block">Tipo Descuento</label>
                                <div className="flex bg-slate-100 p-1 rounded-lg">
                                    <button 
                                        onClick={() => setFormData({...formData, valueType: 'percent'})}
                                        className={`flex-1 py-2 text-sm font-medium rounded-md flex justify-center items-center gap-1 ${formData.valueType === 'percent' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}
                                    >
                                        <Percent className="w-4 h-4" /> %
                                    </button>
                                    <button 
                                        onClick={() => setFormData({...formData, valueType: 'fixed'})}
                                        className={`flex-1 py-2 text-sm font-medium rounded-md flex justify-center items-center gap-1 ${formData.valueType === 'fixed' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'}`}
                                    >
                                        <Euro className="w-4 h-4" /> ‚Ç¨
                                    </button>
                                </div>
                            </div>
                            <div className="flex-1">
                                <InputGroup label="Valor del Descuento" type="number" placeholder={formData.valueType === 'percent' ? "20" : "10"} value={formData.valueAmount} onChange={(e) => setFormData({...formData, valueAmount: e.target.value})} suffix={formData.valueType === 'percent' ? "%" : "‚Ç¨"} />
                            </div>
                          </div>

                          {/* Alcance Financiero Detallado */}
                          <div className="p-5 bg-indigo-50/50 border border-indigo-100 rounded-lg space-y-4">
                            <label className="text-sm font-bold text-indigo-900 flex items-center gap-2">
                                <Euro className="w-4 h-4" />
                                Alcance Financiero
                            </label>

                            {/* Nivel 1: Producto */}
                            <div className="space-y-2">
                                <p className="text-xs font-bold text-indigo-800 uppercase">1. ¬øQu√© productos afecta?</p>
                                <div className="flex gap-2">
                                    {['ticket_only', 'addon_only', 'total_bundle'].map((opt) => (
                                        <button
                                            key={opt}
                                            onClick={() => setFormData({...formData, productScope: opt})}
                                            className={`px-3 py-1.5 text-xs font-medium rounded-md border transition-all ${
                                                formData.productScope === opt 
                                                ? 'bg-indigo-600 text-white border-indigo-600' 
                                                : 'bg-white text-slate-600 border-slate-200 hover:border-indigo-300'
                                            }`}
                                        >
                                            {opt === 'ticket_only' && 'Solo Entrada'}
                                            {opt === 'addon_only' && 'Solo Complementos'}
                                            {opt === 'total_bundle' && 'Entrada + Compl.'}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* Nivel 2: Componentes */}
                            <div className="space-y-2 pt-2 border-t border-indigo-100">
                                <p className="text-xs font-bold text-indigo-800 uppercase">2. ¬øQu√© componentes del precio?</p>
                                <div className="grid grid-cols-2 gap-y-2 gap-x-4">
                                     <CheckboxLabel label="Precio Total" checked={formData.componentScope.totalPrice} onChange={() => toggleComponent('totalPrice')} />
                                     <CheckboxLabel label="Adelantos (Prepago)" checked={formData.componentScope.prepay} onChange={() => toggleComponent('prepay')} />
                                     <CheckboxLabel label="Precio por Persona" checked={formData.componentScope.perPerson} onChange={() => toggleComponent('perPerson')} />
                                     <CheckboxLabel label="Cover Charge (Fee)" checked={formData.componentScope.coverCharge} onChange={() => toggleComponent('coverCharge')} />
                                     <CheckboxLabel label="Min Spend (Consumo)" checked={formData.componentScope.minSpend} onChange={() => toggleComponent('minSpend')} />
                                </div>
                            </div>
                          </div>

                          {/* L√≠mites y Fechas */}
                          <div className="grid grid-cols-2 gap-6">
                             <InputGroup 
                                label="L√≠mite Global de Usos" 
                                placeholder="Vac√≠o = Ilimitado" 
                                value={formData.globalLimit} 
                                onChange={(e) => setFormData({...formData, globalLimit: e.target.value})} 
                             />
                             <InputGroup 
                                label="L√≠mite por Comprador" 
                                placeholder="1" 
                                value={formData.buyerLimit} 
                                onChange={(e) => setFormData({...formData, buyerLimit: e.target.value})} 
                             />
                             <InputGroup 
                                label="V√°lido desde" 
                                type="date" 
                                value={formData.startDate} 
                                onChange={(e) => setFormData({...formData, startDate: e.target.value})} 
                                icon={Calendar} 
                             />
                             <InputGroup 
                                label="V√°lido hasta" 
                                type="date" 
                                value={formData.endDate} 
                                onChange={(e) => setFormData({...formData, endDate: e.target.value})} 
                                icon={Calendar} 
                             />
                          </div>
                        </div>
                      )}

                      {/* STEP 3: TARGETING */}
                      {step === 3 && (
                        <div className="space-y-6 animate-in fade-in slide-in-from-right-4">
                          <div className="bg-amber-50 p-3 rounded-md text-xs text-amber-800 flex gap-2">
                             <AlertCircle className="w-4 h-4 shrink-0 mt-0.5" />
                             <span>La selecci√≥n es en cascada: Si seleccionas un Venue, se aplicar√° a todos sus Eventos y Productos autom√°ticamente.</span>
                          </div>

                          <div className="border border-slate-200 rounded-lg overflow-hidden bg-white">
                                <div className="bg-slate-50 px-4 py-3 border-b border-slate-200">
                                    <h4 className="font-bold text-sm text-slate-700">Asignaci√≥n Jer√°rquica</h4>
                                </div>
                                {/* Mock Tree */}
                                <div className="max-h-[400px] overflow-y-auto p-4 space-y-4">
                                    <HierarchyItem icon={Globe} title="Web de Ventas Principal" level={0} isOpenDefault={true}>
                                        <HierarchyItem icon={MapPin} title="Sala Kapital" level={1} isOpenDefault={true}>
                                            <HierarchyItem icon={Calendar} title="Evento: Viernes Noche" level={2} isOpenDefault={true}>
                                                <div className="pl-6 space-y-2 pt-1">
                                                    <SimpleCheckbox label="Entrada General" checked={true} />
                                                    <SimpleCheckbox label="Mesa VIP Gold (4pax)" checked={true} />
                                                </div>
                                            </HierarchyItem>
                                        </HierarchyItem>
                                    </HierarchyItem>
                                </div>
                           </div>
                        </div>
                      )}

                    </div>

                    {/* Modal Footer */}
                    <div className="bg-white border-t border-slate-100 p-6 flex justify-between items-center">
                      {step > 1 ? (
                         <button onClick={() => setStep(step - 1)} className="text-slate-500 font-medium hover:text-slate-800 px-4 py-2">Atr√°s</button>
                      ) : <div></div>}
                      
                      <button 
                        onClick={() => step < 3 ? setStep(step + 1) : handleCreate()}
                        className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-sm shadow-indigo-200 flex items-center gap-2"
                      >
                        {step < 3 ? (<>Siguiente <ChevronRight className="w-4 h-4" /></>) : 'Guardar Campa√±a'}
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        }

        // --- SUBCOMPONENTS ---

        function HierarchyItem({ icon: Icon, title, level, children, isOpenDefault }) {
            const [isOpen, setIsOpen] = useState(isOpenDefault || false);
            const indent = level * 24;
            return (
                <div className="select-none">
                    <div 
                        className="flex items-center gap-2 py-1.5 hover:bg-slate-50 rounded cursor-pointer"
                        style={{ paddingLeft: `${indent}px` }}
                        onClick={() => setIsOpen(!isOpen)}
                    >
                        <div className="p-0.5 rounded hover:bg-slate-200 transition-colors">
                            {children ? <ChevronDown className={`w-4 h-4 text-slate-400 transition-transform ${isOpen ? '' : '-rotate-90'}`} /> : <div className="w-4 h-4" />}
                        </div>
                        <input type="checkbox" className="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" onClick={(e) => e.stopPropagation()} />
                        <Icon className="w-4 h-4 text-slate-500" />
                        <span className="text-sm font-medium text-slate-700">{title}</span>
                    </div>
                    {isOpen && children && (
                        <div className="border-l border-slate-100 ml-[11px]" style={{ marginLeft: `${indent + 11}px` }}>
                            <div style={{ marginLeft: `-${indent + 11}px` }}>{children}</div>
                        </div>
                    )}
                </div>
            )
        }

        function SimpleCheckbox({ label, checked, isAddon }) {
            return (
                <label className="flex items-center gap-3 py-1.5 hover:bg-slate-50 rounded cursor-pointer">
                    <input type="checkbox" className="w-4 h-4 rounded border-slate-300 text-indigo-600 focus:ring-indigo-500" defaultChecked={checked} />
                    <div className="flex items-center gap-2">
                        {isAddon ? <ShoppingBag className="w-3.5 h-3.5 text-slate-400" /> : <Ticket className="w-3.5 h-3.5 text-slate-400" />}
                        <span className="text-sm text-slate-600">{label}</span>
                        {isAddon && <span className="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded">Complemento</span>}
                    </div>
                </label>
            )
        }

        function CheckboxLabel({ label, checked, onChange }) {
            return (
                <label className="flex items-center gap-2 cursor-pointer p-1 rounded hover:bg-indigo-100/50">
                    <input type="checkbox" checked={checked} onChange={onChange} className="w-4 h-4 rounded border-indigo-200 text-indigo-600 focus:ring-indigo-500" />
                    <span className="text-sm text-indigo-900">{label}</span>
                </label>
            )
        }

        function KpiCard({ title, value, icon: Icon, color, bg, sub }) {
          return (
            <div className="bg-white p-5 rounded-xl border border-slate-200 shadow-sm flex items-start justify-between">
              <div>
                <p className="text-slate-500 text-xs font-bold uppercase tracking-wider">{title}</p>
                <h3 className="text-2xl font-bold text-slate-800 mt-1">{value}</h3>
                {sub && <p className="text-xs text-slate-400 mt-1">{sub}</p>}
              </div>
              <div className={`p-3 rounded-lg ${bg} ${color}`}>
                <Icon className="w-5 h-5" />
              </div>
            </div>
          );
        }

        function StepIndicator({ num, title, current }) {
            const isActive = current >= num;
            const isCurrent = current === num;
            return (
                <div className="flex flex-col items-center gap-2 z-10">
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold border-2 transition-colors ${
                        isActive ? 'bg-indigo-600 border-indigo-600 text-white' : 'bg-white border-slate-300 text-slate-400'
                    }`}>
                        {num}
                    </div>
                    <span className={`text-xs font-medium ${isCurrent ? 'text-indigo-600' : 'text-slate-400'}`}>{title}</span>
                </div>
            )
        }

        function InputGroup({ label, type = "text", placeholder, value, onChange, suffix, icon: Icon }) {
            return (
                <div className="w-full">
                    <label className="text-sm font-bold text-slate-700 mb-1.5 block">{label}</label>
                    <div className="relative flex items-center">
                        {Icon && <Icon className="absolute left-3 w-4 h-4 text-slate-400" />}
                        <input 
                            type={type} 
                            className={`w-full border border-slate-300 rounded-lg py-2.5 px-3 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all ${Icon ? 'pl-9' : ''}`}
                            placeholder={placeholder}
                            value={value}
                            onChange={onChange}
                        />
                        {suffix && <span className="absolute right-3 text-slate-400 text-sm font-medium">{suffix}</span>}
                    </div>
                </div>
            )
        }

        function SelectableCard({ selected, onClick, icon: Icon, title, desc }) {
            return (
                <div 
                    onClick={onClick}
                    className={`cursor-pointer border-2 rounded-xl p-4 transition-all hover:border-indigo-300 ${selected ? 'border-indigo-600 bg-indigo-50' : 'border-slate-200 bg-white'}`}
                >
                    <div className="flex items-start gap-3">
                        <div className={`p-2 rounded-full ${selected ? 'bg-indigo-100 text-indigo-600' : 'bg-slate-100 text-slate-400'}`}>
                            <Icon className="w-5 h-5" />
                        </div>
                        <div>
                            <h4 className={`font-bold text-sm ${selected ? 'text-indigo-900' : 'text-slate-700'}`}>{title}</h4>
                            <p className="text-xs text-slate-500 mt-0.5">{desc}</p>
                        </div>
                    </div>
                </div>
            )
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PromotionsModule />);
    </script>

</body>
</html>
